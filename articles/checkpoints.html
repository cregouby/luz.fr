<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sauvegarder des instantannés de vos modèle • luz.fr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sauvegarder des instantannés de vos modèle">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Passer au contenu</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Navigation sur le site"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">luz.fr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Activer la navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Utiliser luz</h6></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">Bien démarrer</a></li>
    <li><a class="dropdown-item" href="../articles/custom-loop.html">Boucles personnalisées</a></li>
    <li><a class="dropdown-item" href="../articles/accelerator.html">l'API des accélérateurs</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/lr-finder.html">Recherche du taux d'apprentissage avec lr_finder</a></li>
    <li><a class="dropdown-item" href="../articles/checkpoints.html">Instantannés de modèles</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Référence</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changements</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/luz/"><span class="fa fab fa-github fa-lg"></span> Contribuer</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Sauvegarder des instantannés de vos modèle</h1>
            
      
      <small class="dont-index">Source : <a href="https://github.com/cregouby/luz.fr/blob/HEAD/vignettes/articles/checkpoints.Rmd" class="external-link"><code>vignettes/articles/checkpoints.Rmd</code></a></small>
      <div class="d-none name"><code>checkpoints.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/luz/" class="external-link">luz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html" class="external-link">torch_manual_seed</a></span><span class="op">(</span><span class="fl">1703</span><span class="op">)</span></span></code></pre></div>
<p>Lorsque vous entraînez des modèles qui prennent beaucoup de temps,
vous souhaitez peut-être enregistrer l’état intermédiaire du modèle sur
disque. Ainsi, si quelque chose se passe mal pendant l’apprentissage
(par exemple, un processus annihilé, une coupure réseau, un manque de
mémoire, etc), vous pourrez reprendre l’entraînement à partir là où il
s’est arrêté.</p>
<p>Vous pouvez aussi avoir besoin des états intermédiaires pour évaluer
le modèle à différents moments de l’apprentissage, par exemple comparer
les résultats après 10 époques et après 30 époques.</p>
<p>Cet article décrit les fonctionnalités de luz qui sont conçues à cet
effet. Ces fonctionnalités sont facultatives et sont activées seulement
si vous ajoutez des <code>callbacks</code> spécifiques à votre appel à
<code>fit</code>.</p>
<div class="section level2">
<h2 id="relancer-des-apprentissages-qui-ont-échoués">Relancer des apprentissages qui ont échoués<a class="anchor" aria-label="anchor" href="#relancer-des-apprentissages-qui-ont-%C3%A9chou%C3%A9s"></a>
</h2>
<p>Si vous avez un long processus d’apprentissage qui peut échouer pour
n’importe quelle raison (ordinateur coupé, noeud d’un cluster perdu,
etc), il est recommandé d’ajouter <code>luz_callback_autoresume()</code>
à votre liste de <code>callbacks</code>.</p>
<p><code>luz_callback_autoresume()</code> sauvegardera automatiquement
tout l’état de votre modèle à la fin de chaque époque. Si quelque chose
se passe mal pendant l’apprentissage, vous pouvez simplement relancer le
même script, sans aucun changement, le dernier instantanné du modèle
sera rechargé et l’apprentissage reprendra là où il s’est arrêté.</p>
<p>Par exemple, prennons un jeu de données d’entraînement aléatoire
généré et un modèle linéaire pour montrer comment fonctionne
<code>autoresume</code>.</p>
<p>Voici les données d’entraînement :</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Et la définition du modèle :</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">nn_linear</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="va">optim_sgd</span>, loss <span class="op">=</span> <span class="va">nnf_mse_loss</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_hparams.html">set_hparams</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">10</span>, out_features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p>Voici comment créer un <code>callbacks</code> qui simule une erreur
aléatoire. Ce <code>callbacks</code> lève juste une erreur d’exécution R
à la 5ème époque d’apprentissage du modèle.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interrupt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  <span class="st">"interrupt"</span>,</span>
<span>  failed <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  on_epoch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="va">self</span><span class="op">$</span><span class="va">failed</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">failed</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Error on epoch 5"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Ccommençons par entraîner en ajoutant le
<code><a href="../reference/luz_callback_auto_resume.html">luz_callback_auto_resume()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">autoresume</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback_auto_resume.html">luz_callback_auto_resume</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"state.pt"</span><span class="op">)</span></span>
<span><span class="va">inter</span> <span class="op">&lt;-</span> <span class="fu">interrupt</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Une erreur se produira à la 5ème époque et le modèle sera arrêté.</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">fit</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">inter</span>, <span class="va">autoresume</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   objet 'type_sum.accel' introuvable</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `FUN()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Error while calling callback with class <span style="color: #0000BB;">&lt;interrupt/LuzCallback/R6&gt;</span> at</span></span>
<span><span class="co">#&gt;   <span style="color: #00BB00;">on_epoch_end</span>.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error in `self[[callback_nm]]()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Error on epoch 5</span></span></code></pre></div>
<p>Pour relancer l’apprentissage du modèle exactement là où il s’est
arrêté, vous n’avez qu’à relancer la fonction <code>fit()</code> avec le
même modèle, les <code>callbacks</code>, etc. :</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">fit</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">inter</span>, <span class="va">autoresume</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Ainsi, le processus l’apprentissage du modèle continuera exactement
là où il s’est arrêté. Les registres (de métriques et de pertes),
l’optimiseur et l’état du modèle sont récupérés à partir de l’état
précédent pour avoir les résultats complets :</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="checkpoints_files/figure-html/plots-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="sauvegarde-automatique">Sauvegarde automatique<a class="anchor" aria-label="anchor" href="#sauvegarde-automatique"></a>
</h2>
<p>Si vous désirez avoir un contrôle plus fin sur la façon dont les
sauvegardes sont gérées, vous pouvez utiliser
<code><a href="../reference/luz_callback_model_checkpoint.html">luz_callback_model_checkpoint()</a></code> pour enregistrer des
sauvegardes dans un fichier ou un répertoire spécifié.</p>
<p>Essayons d’utiliser le même exemple que dans la section précédente :
Nous générerons d’abord quelques données.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Définissons à nouveau notre modèle :</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">nn_linear</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="va">optim_sgd</span>, loss <span class="op">=</span> <span class="va">nnf_mse_loss</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_hparams.html">set_hparams</a></span><span class="op">(</span>in_features <span class="op">=</span> <span class="fl">10</span>, out_features <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p>Entraînons maintenant le modèle en utilisant
<code><a href="../reference/luz_callback_model_checkpoint.html">luz_callback_model_checkpoint()</a></code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">checkpoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback_model_checkpoint.html">luz_callback_model_checkpoint</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="st">"checkpoints/"</span>, </span>
<span>  monitor <span class="op">=</span> <span class="st">"train_loss"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">fit</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">checkpoint</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Vous pouvez maintenant voir que le répertoire
<code>checkpoints</code> contient des fichiers avec des sauvegardes de
l’état pour chaque epoch. Par défaut,
<code>luz_callback_model_checkpoint</code> enregistrera l’état pour
chaque epochs et formattera le nom en y incluant la valeur de la perte.
Ce formattage peut être configuré dans le paramètre path, voir
<code><a href="../reference/luz_callback_model_checkpoint.html">?luz_callback_model_checkpoint</a></code> pour plus de détails.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="st">"checkpoints"</span><span class="op">)</span></span>
<span><span class="co">#&gt; checkpoints/epoch-01-train_loss-1.237.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-02-train_loss-1.065.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-03-train_loss-1.026.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-04-train_loss-1.004.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-05-train_loss-1.004.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-06-train_loss-1.005.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-07-train_loss-0.999.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-08-train_loss-0.998.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-09-train_loss-1.001.pt</span></span>
<span><span class="co">#&gt; checkpoints/epoch-10-train_loss-1.002.pt</span></span></code></pre></div>
<p>Enfin, vous pouvez charger une sauvegarde spécifique dans le modèle
entrainé à l’aide de <code>luz_load_checkpoint</code>. Notez que la
chargement de la sauvegarde dans un module <code>fitted</code> remplace
les poids sur le modèle en mémoire.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/luz_load_checkpoint.html">luz_load_checkpoint</a></span><span class="op">(</span><span class="va">results</span>, <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">dir_ls</a></span><span class="op">(</span><span class="st">"checkpoints"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p>Vous pouvez ensuite commencer à faire des prédictions ou évaluer
votre modèle avec les poids tout juste chargés.</p>
<p>Si vous voullez démarrer une nouvelle époque d’apprentissage depuis
une sauvegarde, vous pouvez utiliser
<code><a href="../reference/luz_callback_resume_from_checkpoint.html">luz_callback_resume_from_checkpoint()</a></code> . Par défaut, il
n’aura enregistré que les poids du modèle dans le fichier de sauvegarde,
mais vous pouvez configurer pour restorer aussi les registres,
<code>callbacks</code> et états de l’optimiseur. Si le répertoire des
sauvegardes existantes est indiqué, alors l’apprentissage reprendra à
partir du dernier fichier de sauvegarde renvoyé par
<code><a href="https://fs.r-lib.org/reference/dir_ls.html" class="external-link">fs::dir_ls</a></code>.</p>
<p>Voici comment utiliser ce <code>callbacks</code> :</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resume</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback_resume_from_checkpoint.html">luz_callback_resume_from_checkpoint</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"checkpoints/"</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">fit</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>  callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">resume</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="checkpoints_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="section level3">
<h3 id="états-des-callbacks-personnalisés">États des <code>callbacks</code> personnalisés<a class="anchor" aria-label="anchor" href="#%C3%A9tats-des-callbacks-personnalis%C3%A9s"></a>
</h3>
<p>Parfois, les rappels ont également besoin de conserver leurs états
internes afin de continuer l’apprentissage exactement à partir là où il
s’est arrêté. Dans ce cas, les <code>callbacks</code> peuvent mettre en
œuvre les méthodes <code>state_dict()</code> et le
<code><a href="https://rdrr.io/pkg/torch/man/load_state_dict.html" class="external-link">load_state_dict()</a></code> qui sont appelées automatiquement lors
des sauvegardes et rechargements.</p>
<p>Par exemple, imaginez que vous avez crée un <code>callbacks</code>
qui suit les gradients des poids du modèle à chaque epoch. Vous voulez
utiliser les poids suivis pour analyser plus en profondeur la procédure
d’apprentissage. Ce rappel pourrait être configuré comme suit:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cb_weight_grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  <span class="st">"weight_grad"</span>,</span>
<span>  gradients <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span></span>
<span>  <span class="op">}</span>,</span>
<span>  on_train_batch_before_step <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">w</span> <span class="kw">in</span> <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Dans l’exemple ci-dessus, le champ <code>gradients</code> est un
<strong>état</strong> dans le <code>callbacks</code>. Si l’apprentissage
échoue pour une raison quelconque, les états seront perdues.</p>
<p>Nous pouvons le rendre persistant en utilisant les méthodes
<code>state_dict()</code> et <code><a href="https://rdrr.io/pkg/torch/man/load_state_dict.html" class="external-link">load_state_dict()</a></code> comme suit
:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cb_weight_grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  <span class="st">"weight_grad"</span>,</span>
<span>  gradients <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span></span>
<span>  <span class="op">}</span>,</span>
<span>  on_train_batch_before_step <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">w</span> <span class="kw">in</span> <span class="va">self</span><span class="op">$</span><span class="va">track_weights</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">gradients</span><span class="op">[[</span><span class="va">ctx</span><span class="op">$</span><span class="va">epoch</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">parameters</span><span class="op">[[</span><span class="va">w</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  state_dict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gradients <span class="op">=</span> <span class="va">self</span><span class="op">$</span><span class="va">gradients</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  load_state_dict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">gradients</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">$</span><span class="va">gradients</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table des matières"><h2>Sur cette page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Développé par Christophe Regouby.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site créé avec <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
