<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Entraîner un modèle linguistique causal à partir de zéro • luz.fr</title>
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Entraîner un modèle linguistique causal à partir de zéro">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Passer au contenu</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Navigation sur le site"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">luz.fr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Activer la navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Utiliser luz</h6></li>
    <li><a class="dropdown-item" href="../../articles/get-started.html">Bien démarrer</a></li>
    <li><a class="dropdown-item" href="../../articles/custom-loop.html">Boucles personnalisées</a></li>
    <li><a class="dropdown-item" href="../../articles/accelerator.html">l'API des accélérateurs</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../../articles/lr-finder.html">Recherche du taux d'apprentissage avec lr_finder</a></li>
    <li><a class="dropdown-item" href="../../articles/checkpoints.html">Instantannés de modèles</a></li>
  </ul>
</li>
<li class="active nav-item"><a class="nav-link" href="../../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Référence</a></li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changements</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mlverse/luz/"><span class="fa fab fa-github fa-lg"></span> Contribuer</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Entraîner un modèle linguistique causal à partir de zéro</h1>
            
      
      <small class="dont-index">Source : <a href="https://github.com/cregouby/luz.fr/blob/HEAD/vignettes/examples/text-generation.Rmd" class="external-link"><code>vignettes/examples/text-generation.Rmd</code></a></small>
      <div class="d-none name"><code>text-generation.Rmd</code></div>
    </div>

    
    
<p>Cet exemple est une adaptation du cours ‘Entraîner un modèle
linguistique causal à partir de zéro’ du <a href="https://huggingface.co/learn/nlp-course/chapter7/6?fw=pt" class="external-link">Hugging
Face NLP course</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mlverse/tok" class="external-link">tok</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/luz/" class="external-link">luz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">minhub</span><span class="op">)</span> <span class="co"># remotes::install_github("mlverse/minhub")</span></span>
<span><span class="co">#library(tidyverse)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>arrow.skip_nul <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="données">Données<a class="anchor" aria-label="anchor" href="#donn%C3%A9es"></a>
</h2>
<p>La première étape est d’implémenter un jeu de données torch qui
rassemble des données et les pré-traite pour qu’elles soient au format
approprié pour entraîner le modèle.</p>
<p>Cela signifie que nous devons :</p>
<ol style="list-style-type: decimal">
<li>Télécharger les données textuelles</li>
<li>Entraîner un tokeniseur pour ce jeu de données</li>
<li>Être en mesure de produire des séquences de tokens dans le format
attendu par le modèle</li>
</ol>
<p>Nous allons utiliser 2 jeux de données disponibles sur le Hub
d’Hugging Face. Le premier contient tous les codes sources des paquets R
disponibles sur CRAN. Le second contient tous les codes R qui sont
disponibles dans les dumps GitHub. Les deux jeux de données sont au
format Parquet. Nous allons implémenter une fonction qui télécharge et
cache les données, puis renvoie une seule table au format arrow
contenant toutes les données.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">read_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">source</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">source</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">hfhub</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/hfhub/reference/hub_snapshot.html" class="external-link">hub_snapshot</a></span><span class="op">(</span>repo_type <span class="op">=</span> <span class="st">"dataset"</span>, allow_patterns <span class="op">=</span> <span class="st">"parquet$"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path.html" class="external-link">path</a></span><span class="op">(</span><span class="st">"data/r"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">".*\\.[rR]$"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">content</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>content <span class="op">=</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/cast.html" class="external-link">cast</a></span><span class="op">(</span><span class="va">content</span>, <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/data-type.html" class="external-link">string</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">content</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="co"># le jeu de données contient des caractères utf8 invalides...</span></span>
<span>    <span class="co"># nous devons les supprimer, sinon on obtient une erreur des tokenizers</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">utf8</span><span class="fu">::</span><span class="fu"><a href="https://ptrckprry.com/r-utf8/reference/as_utf8.html" class="external-link">utf8_valid</a></span><span class="op">(</span><span class="va">content</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">read_datasets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="fu">read_dataset</span><span class="op">(</span><span class="st">"dfalbel/cran-packages"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_dataset</span><span class="op">(</span><span class="st">"dfalbel/github-r-repos"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Ensuite, nous implémentons une fonction qui entraîne un tokeniseur
sur notre jeu de données.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">create_tokenizer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">vocab_size</span>, <span class="va">special_tokens</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tok</span> <span class="op">&lt;-</span> <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/tokenizer.html" class="external-link">tokenizer</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/model_bpe.html" class="external-link">model_bpe</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">tok</span><span class="op">$</span><span class="va">pre_tokenizer</span> <span class="op">&lt;-</span> <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/pre_tokenizer_byte_level.html" class="external-link">pre_tokenizer_byte_level</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>add_prefix_space <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">tok</span><span class="op">$</span><span class="va">decoder</span> <span class="op">&lt;-</span> <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/decoder_byte_level.html" class="external-link">decoder_byte_level</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">tok</span><span class="op">$</span><span class="va">post_processor</span> <span class="op">&lt;-</span> <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/processor_byte_level.html" class="external-link">processor_byte_level</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>trim_offsets <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">tok</span><span class="op">$</span><span class="fu">train_from_memory</span><span class="op">(</span></span>
<span>    <span class="va">text</span>,</span>
<span>    <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/trainer_bpe.html" class="external-link">trainer_bpe</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>vocab_size <span class="op">=</span> <span class="va">vocab_size</span>, special_tokens <span class="op">=</span> <span class="va">special_tokens</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">tok</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># code de débogage pour le tokeniseur</span></span>
<span><span class="co"># data &lt;- read_datasets()</span></span>
<span><span class="co"># tok &lt;- create_tokenizer(data$content)</span></span></code></pre></div>
<p>Nous pouvons enfin implémenter le jeu de données torch que nous
allons utiliser pour entraîner le modèle. Nous allons utiliser
<code><a href="https://torch.mlverse.org/docs/reference/iterable_dataset.html" class="external-link">torch::iterable_dataset</a></code> au lieu de
<code><a href="https://torch.mlverse.org/docs/reference/dataset.html" class="external-link">torch::dataset</a></code>. La principale motivation est que nous ne
pouvons pas<br>
vraiment savoir le nombre total d’échantillons dans le jeu de données,
donc nous pouvons implémenter une méthode <code>.getitem()</code> pour
obtenir n’importe quel échantillon arbitraire. Ainsi, nous implémentons
la méthode <code>.iter</code> qui retourne<br>
un nouvel échantillon à chaque appel.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_sources_dataset</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/iterable_dataset.html" class="external-link">iterable_dataset</a></span><span class="op">(</span></span>
<span>  <span class="st">"r_sources_dataset"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">root</span> <span class="op">=</span> <span class="st">"."</span>, <span class="va">vocab_size</span> <span class="op">=</span> <span class="fl">20000</span>, <span class="va">context_length</span> <span class="op">=</span> <span class="fl">128</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">read_datasets</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">context_length</span> <span class="op">&lt;-</span> <span class="va">context_length</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># nous créons un tokeniseur que si celui-ci n'existe pas déjà, sinon nous le chargeons simplement</span></span>
<span>    <span class="va">tok_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">root</span>, <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"tokenizer-{vocab_size}.json"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">tok_path</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">tok</span> <span class="op">&lt;-</span> <span class="fu">create_tokenizer</span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">content</span><span class="op">)</span>,</span>
<span>        <span class="va">vocab_size</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt;fbegin&gt;"</span>, <span class="st">"&lt;fend&gt;"</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html" class="external-link">dir_create</a></span><span class="op">(</span><span class="va">root</span><span class="op">)</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">tok</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span><span class="va">tok_path</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">self</span><span class="op">$</span><span class="va">tok</span> <span class="op">&lt;-</span> <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/tokenizer.html" class="external-link">tokenizer</a></span><span class="op">$</span><span class="fu">from_file</span><span class="op">(</span><span class="va">tok_path</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  .iter <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>    <span class="va">sequence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sequence</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">context_length</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="va">i</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">sequence</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="va">sequence</span>,</span>
<span>          <span class="va">self</span><span class="op">$</span><span class="va">tok</span><span class="op">$</span><span class="fu">encode</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"&lt;fbegin&gt;"</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">content</span><span class="op">[</span><span class="va">self</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"&lt;fend&gt;"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sequence</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">context_length</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://coro.r-lib.org/reference/iterator.html" class="external-link">exhausted</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="op">{</span></span>
<span>        <span class="va">sequence</span> <span class="op">&lt;&lt;-</span> <span class="va">sequence</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">context_length</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        input_ids <span class="op">=</span> <span class="va">sequence</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">context_length</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1L</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">sequence</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">context_length</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># code de débogage pour le jeu de données</span></span>
<span><span class="co"># ds &lt;- r_sources_dataset("~/Downloads/")</span></span>
<span><span class="co"># it &lt;- ds$.iter()</span></span>
<span><span class="co"># it()</span></span>
<span><span class="co"># ds$tok$get_vocab_size()</span></span></code></pre></div>
<p>Ce jeu de données est bien trop volumineux pour entraîner le modèle
sur tous les documents dans cet exemple. Il est également difficile de
prédire combien de temps cela prendra d’arriver à la fin de
l’entraînement. Pour simplifier, nous définissons un jeu de données
itérable utilisé pour exécuter le jeu de données ci-dessus pendant un
nombre fixe d’étapes. Ce n’est pas nécessaire, mais rend l’utilisation
de luz plus agréable, car nous pouvons facilement définir combien de
tokens nous voulons entraîner notre modèle.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fixed_steps_iterable_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/iterable_dataset.html" class="external-link">iterable_dataset</a></span><span class="op">(</span></span>
<span>  <span class="st">"fixed_steps_dataset"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">steps</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="va">dataset</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">steps</span> <span class="op">&lt;-</span> <span class="va">steps</span></span>
<span>  <span class="op">}</span>,</span>
<span>  .iter <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>    <span class="va">iter</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&gt;</span> <span class="va">self</span><span class="op">$</span><span class="va">steps</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://coro.r-lib.org/reference/iterator.html" class="external-link">exhausted</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="va">i</span> <span class="op">&lt;&lt;-</span> <span class="va">i</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span> <span class="op">||</span> <span class="fu">coro</span><span class="fu">::</span><span class="fu"><a href="https://coro.r-lib.org/reference/iterator.html" class="external-link">is_exhausted</a></span><span class="op">(</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">iter</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">iter</span> <span class="op">&lt;&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">dataset</span><span class="op">$</span><span class="fu">.iter</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">iter</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="va">data</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span>  .length <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">steps</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Maintenant, nous pouvons définir le modèle que nous allons entraîner.
Nous utiliserons une version légère de GPT2. Nous définissons également
une méthode <code>generate</code> nous permettant d’échantillonner à
partir du modèle donné un contexte initial.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">gpt</span> <span class="op">&lt;-</span> <span class="fu">minhub</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/minhub/man/gpt2.html" class="external-link">gpt2</a></span><span class="op">(</span></span>
<span>      vocab_size <span class="op">=</span> <span class="fl">20000</span>,</span>
<span>      pdrop <span class="op">=</span> <span class="fl">0.1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">gpt</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="fu">transpose</span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  generate <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">temperature</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">iter</span> <span class="op">=</span> <span class="fl">50</span>, <span class="va">top_k</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># échantillonne à partir du modèle given un vecteur de contexte.</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">iter</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">logits</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">forward</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span>,,<span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>      <span class="va">logits</span> <span class="op">&lt;-</span> <span class="va">logits</span><span class="op">/</span><span class="va">temperature</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">prob</span>, <span class="va">ind</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/zeallot/man/operator.html" class="external-link">%&lt;-%</a></span> <span class="va">logits</span><span class="op">$</span><span class="fu">topk</span><span class="op">(</span><span class="va">top_k</span><span class="op">)</span></span>
<span>      <span class="va">logits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_full_like.html" class="external-link">torch_full_like</a></span><span class="op">(</span><span class="va">logits</span>, <span class="op">-</span><span class="cn">Inf</span><span class="op">)</span><span class="op">$</span><span class="fu">scatter_</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="va">ind</span>, <span class="va">prob</span><span class="op">)</span></span>
<span>      <span class="va">logits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nnf_softmax.html" class="external-link">nnf_softmax</a></span><span class="op">(</span><span class="va">logits</span>, dim <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">id_next</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_multinomial.html" class="external-link">torch_multinomial</a></span><span class="op">(</span><span class="va">logits</span>, num_samples <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_cat.html" class="external-link">torch_cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">id_next</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">x</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># code de débogage pour le modèle</span></span>
<span><span class="co"># ds &lt;- torch::dataloader(r_sources_dataset("~/Downloads/"), batch_size = 32)</span></span>
<span><span class="co"># batch &lt;- coro::collect(ds, 1)[[1]]</span></span>
<span><span class="co"># str(batch)</span></span>
<span><span class="co"># m &lt;- net()</span></span>
<span><span class="co"># str(m(batch$input_ids))</span></span></code></pre></div>
<p>Pour faciliter l’inspection de la formation, nous définirons
également un callback qui imprime un échantillon du modèle à chaque
époque.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># échantillonne à partir du modèle en utilisant le contexte.</span></span>
<span><span class="va">generate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">tok</span>, <span class="va">context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://torch.mlverse.org/docs/reference/with_no_grad.html" class="external-link">local_no_grad</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># désactive les gradients pour l'échantillonnage</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">tok</span><span class="op">$</span><span class="fu">encode</span><span class="op">(</span><span class="va">context</span><span class="op">)</span><span class="op">$</span><span class="va">ids</span> <span class="op">+</span> <span class="fl">1L</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_tensor.html" class="external-link">torch_tensor</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="cn">NULL</span>,<span class="op">]</span><span class="op">$</span><span class="fu">to</span><span class="op">(</span>device <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">device</span><span class="op">)</span></span>
<span>  <span class="va">content</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">$</span><span class="fu">cpu</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tok</span><span class="op">$</span><span class="fu">decode</span><span class="op">(</span><span class="va">content</span> <span class="op">-</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">display_cb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/luz_callback.html">luz_callback</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span><span class="op">}</span>,</span>
<span>  on_epoch_end <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://torch.mlverse.org/docs/reference/with_no_grad.html" class="external-link">local_no_grad</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="co"># sample from the model...</span></span>
<span>    <span class="va">context</span> <span class="op">&lt;-</span> <span class="st">"# creates a linear model"</span></span>
<span>    <span class="va">text</span> <span class="op">&lt;-</span> <span class="fu">generate</span><span class="op">(</span><span class="va">ctx</span><span class="op">$</span><span class="va">model</span>, <span class="va">dataset</span><span class="op">$</span><span class="va">dataset</span><span class="op">$</span><span class="va">tok</span>, <span class="va">context</span>, iter <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_rule.html" class="external-link">cli_rule</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">text</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_rule.html" class="external-link">cli_rule</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Nous pouvons maintenant entraîner le modèle. Nous définissons un
entraînement du modèle pour un demi-milliard de tokens pendant un total
de 100 époques.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_tokens</span> <span class="op">&lt;-</span> <span class="fl">500e6</span></span>
<span><span class="va">batch_size</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">epochs</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">context_length</span> <span class="op">&lt;-</span> <span class="fl">256L</span></span>
<span></span>
<span><span class="va">steps</span> <span class="op">&lt;-</span> <span class="va">n_tokens</span> <span class="op">/</span> <span class="va">context_length</span> <span class="op">/</span> <span class="va">epochs</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu">fixed_steps_iterable_dataset</span><span class="op">(</span></span>
<span>  <span class="fu">r_sources_dataset</span><span class="op">(</span>context_length <span class="op">=</span> <span class="va">context_length</span><span class="op">)</span>,</span>
<span>  steps <span class="op">=</span> <span class="va">steps</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="va">net</span> <span class="op"><a href="../../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/setup.html">setup</a></span><span class="op">(</span></span>
<span>    optimizer <span class="op">=</span> <span class="va">optim_adam</span>,</span>
<span>    loss <span class="op">=</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_cross_entropy_loss.html" class="external-link">nn_cross_entropy_loss</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/set_opt_hparams.html">set_opt_hparams</a></span><span class="op">(</span>lr <span class="op">=</span> <span class="fl">3e-4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">fit</span><span class="op">(</span></span>
<span>    <span class="va">dataset</span>,</span>
<span>    epochs <span class="op">=</span> <span class="va">epochs</span>,</span>
<span>    dataloader_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>batch_size <span class="op">=</span> <span class="va">batch_size</span><span class="op">)</span>,</span>
<span>    callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../../reference/luz_callback_lr_scheduler.html">luz_callback_lr_scheduler</a></span><span class="op">(</span></span>
<span>        <span class="fu">torch</span><span class="fu">::</span><span class="va"><a href="https://torch.mlverse.org/docs/reference/lr_one_cycle.html" class="external-link">lr_one_cycle</a></span>,</span>
<span>        max_lr <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>        epochs <span class="op">=</span> <span class="va">epochs</span>,</span>
<span>        steps_per_epoch <span class="op">=</span> <span class="va">steps</span><span class="op">/</span><span class="va">batch_size</span>,</span>
<span>        call_on <span class="op">=</span> <span class="st">"on_batch_end"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu"><a href="../../reference/luz_callback_gradient_clip.html">luz_callback_gradient_clip</a></span><span class="op">(</span>max_norm <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="fu">display_cb</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/luz_save.html" class="external-link">luz_save</a></span><span class="op">(</span><span class="va">fitted</span>, <span class="st">"model.pt"</span><span class="op">)</span></span></code></pre></div>
<p>Ensuite, nous pouvons utiliser le modèle pour générer du texte en
fonction d’un prompt avec :</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="fu">luz</span><span class="fu">::</span><span class="fu"><a href="https://mlverse.github.io/luz/reference/luz_load.html" class="external-link">luz_load</a></span><span class="op">(</span><span class="st">"model.pt"</span><span class="op">)</span></span>
<span><span class="va">tok</span> <span class="op">&lt;-</span> <span class="fu">tok</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/tok/man/tokenizer.html" class="external-link">tokenizer</a></span><span class="op">$</span><span class="fu">from_file</span><span class="op">(</span><span class="st">"tokenizer-20000.json"</span><span class="op">)</span></span>
<span><span class="va">context</span> <span class="op">&lt;-</span> <span class="st">"#' Crée un modèle linéaire</span></span>
<span><span class="st">linear_model &lt;- function(x, y) {</span></span>
<span><span class="st">"</span></span>
<span><span class="va">text</span> <span class="op">&lt;-</span> <span class="fu">generate</span><span class="op">(</span><span class="va">fitted</span><span class="op">$</span><span class="va">model</span>, <span class="va">tok</span>, <span class="va">context</span>, iter <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">text</span><span class="op">)</span></span></code></pre></div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Développé par Christophe Regouby.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site créé avec <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
