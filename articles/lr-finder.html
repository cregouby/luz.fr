<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Utilisation de la recherche de taux d'apprentissage • luz.fr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Utilisation de la recherche de taux d'apprentissage">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Passer au contenu</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Navigation sur le site"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">luz.fr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Activer la navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Utiliser luz</h6></li>
    <li><a class="dropdown-item" href="../articles/get-started.html">Bien démarrer</a></li>
    <li><a class="dropdown-item" href="../articles/custom-loop.html">Boucles personnalisées</a></li>
    <li><a class="dropdown-item" href="../articles/accelerator.html">l'API des périphériques d'accélération</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../articles/lr-finder.html">Recherche du taux d'apprentissage avec lr_finder</a></li>
    <li><a class="dropdown-item" href="../articles/checkpoints.html">Instantannés de modèles</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/examples/index.html">Examples</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Référence</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changements</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cregouby/luz.fr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Utilisation de la recherche de taux d'apprentissage</h1>
            
      
      <small class="dont-index">Source : <a href="https://github.com/cregouby/luz.fr/blob/HEAD/vignettes/articles/lr-finder.Rmd" class="external-link"><code>vignettes/articles/lr-finder.Rmd</code></a></small>
      <div class="d-none name"><code>lr-finder.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlverse.github.io/luz/" class="external-link">luz</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torchvision.mlverse.org" class="external-link">torchvision</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/torch_manual_seed.html" class="external-link">torch_manual_seed</a></span><span class="op">(</span><span class="fl">1703</span><span class="op">)</span></span></code></pre></div>
<p>Dans cet article, nous discutons comment trouver un bon taux
d’apprentissage pour votre modèle. Trouver un bon taux d’apprentissage
est essentiel pour l’apprentissage correct de votre modèle. Si il est
trop faible, vous aurez besoin de trop d’itérations pour que votre
fonction de perte converge, et cela pourrait être inutilisable si votre
modèle prend trop de temps à s’exécuter. Si il est trop élevé, la
fonction de perte peut exploser et vous n’aurez jamais réussi à
minimiser la perte.</p>
<p>Le taux d’apprentissage peut être considéré comme un autre
hyper-paramètre de votre modèle qui nécessite une réglage mais, il
existe des techniques qui permettent de sélectionner un bon taux
d’apprentissage pour votre modèle sans avoir à utiliser la stratégie
coûteuse consistant à ajuster plusieurs modèles avec différents taux
d’apprentissages et en choisissant ensuite le meilleur.</p>
<p>Cet <a href="https://arxiv.org/abs/1506.01186" class="external-link">article</a> de Leslie
Smith qui est devenu populaire après que leur approche ait été mise en
œuvre dans la plateforme FastAI, propose de commencer avec un taux
d’apprentissage très faible et le faire augmenter progressivement
jusqu’à atteindre un taux d’apprentissage élevé. À chaque itération on
enregistre la valeur de perte et à la fin on les visualise en fonction
du taux d’apprentissage. On peut alors utiliser ces résultats pour
décider d’un bon taux d’apprentissage. C’est ce que fait
<code>lr_finder</code>, et nous allons voir comment l’utiliser.</p>
<p>Tout d’abord, téléchargeons et préparons les données de MNIST :</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="st">"~/Downloads/mnist"</span> <span class="co"># répertoire de cache</span></span>
<span></span>
<span><span class="va">train_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torchvision.mlverse.org/reference/mnist_dataset.html" class="external-link">mnist_dataset</a></span><span class="op">(</span></span>
<span>  <span class="va">dir</span>,</span>
<span>  download <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  transform <span class="op">=</span> <span class="va">transform_to_tensor</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>On peut maintenant définir notre modèle. On va utiliser un petit CNN
dans le style LeNet.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  <span class="st">"net"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">32</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool2d.html" class="external-link">nn_max_pool2d</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_conv2d.html" class="external-link">nn_conv2d</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">64</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_max_pool2d.html" class="external-link">nn_max_pool2d</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_dropout.html" class="external-link">nn_dropout</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_flatten.html" class="external-link">nn_flatten</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">classifier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">1600</span>, <span class="fl">128</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_dropout.html" class="external-link">nn_dropout</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">128</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">features</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="va">self</span><span class="op">$</span><span class="fu">classifier</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>On peut maintenant utiliser la fonction <code>lr_finder</code> pour
enregistrer la perte avec différents taux d’apprentissages. Il est
important d’utiliser la rechercheur de taux d’apprentissage avec tous
les autres hyper-paramètres du modèle fixés, car ils peuvent influencer
le choix du taux d’apprentissage. Par exemple, selon la taille des
batches, vous pourriez vouloir choisir différents taux
d’apprentissages.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va">net</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span></span>
<span>  loss <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/torch/man/nn_cross_entropy_loss.html" class="external-link">nn_cross_entropy_loss</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu">torch</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/torch/man/optim_adam.html" class="external-link">optim_adam</a></span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lr_finder.html">lr_finder</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">model</span>, </span>
<span>  data <span class="op">=</span> <span class="va">train_ds</span>, </span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  dataloader_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>batch_size <span class="op">=</span> <span class="fl">32</span><span class="op">)</span>,</span>
<span>  start_lr <span class="op">=</span> <span class="fl">1e-6</span>, <span class="co"># la plus petite valeur qui sera essayée</span></span>
<span>  end_lr <span class="op">=</span> <span class="fl">1</span> <span class="co"># la plus grande valeur à l'essayer</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">records</span><span class="op">)</span></span>
<span><span class="co">#&gt; Classes 'lr_records' and 'data.frame':   100 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;  $ lr  : num  1.15e-06 1.32e-06 1.51e-06 1.74e-06 2.00e-06 ...</span></span>
<span><span class="co">#&gt;  $ loss: num  2.31 2.3 2.29 2.3 2.31 ...</span></span></code></pre></div>
<p>Le résultat est un tableau de données avec les pertes et le taux
d’apprentissage à chaque étape. Vous pouvez utiliser la méthode de
visualisation intégrée pour afficher les résultats exacts, ainsi qu’une
valeur de perte lissée exponentiellement.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">records</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="lr-finder_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>On peut voir que avec des taux d’apprentissage faibles la perte ne
diminue pas. À un certain point la perte commence à diminuer jusqu’à
atteindre un point où elle commence à augmenter et enfin à exploser.</p>
<p>Et comment choisissons-on le taux d’apprentissage en utilisant cette
courbe? Sylvain Gugger a posé cette question dans <a href="https://sgugger.github.io/how-do-you-find-a-good-learning-rate.html" class="external-link">cet
article</a> et répond</p>
<blockquote>
<p>Pas celui correspondant au minimum. Pourquoi ? Eh bien, le taux
d’apprentissage qui correspond à la valeur minimale est déjà un peu trop
élevé, puisque nous sommes à la limite entre l’amélioration et
l’explosion totale. Nous voulons aller à une ordre de grandeur en
dessous, une valeur encore agressive (pour qu’on s’apprenne vite) mais
toujours en retrait par rapport à l’explosion.</p>
</blockquote>
<p>Ainsi, dans notre exemple, on choisira 1e-3 au lieu de 1e-2. On peut
utiliser le taux d’apprentissage ainsi choisi dans notre modèle
principal avec les autres hyper-paramètres ajustés pour obtenir un bon
score et minimiser au mieux la fonction de perte.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Développé par Christophe Regouby.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site créé avec <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
